#+title: Crowdfunding
#+PROPERTY: header-args :var base-url="http://localhost:4000" token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJjcm93ZGZ1bmRpbmdAZ21haWwuY29tIiwiaWF0IjoxNjIyNTM2OTgxLCJleHAiOjE2MzExNzY5ODEsImp0aSI6IjFsNnpuMTNpaHBrcGRzbWo0YiJ9.q8p_mRF5Jj2RacIGW09KSrc4urq2ns9W5eE1HpBYnmg"
* Parchar multer
Ejecutar el siguiente comando:
#+begin_src sh
patch -p0 < multer.patch
#+end_src
* Enviar archivos al servidor
** Código demo en /html/ para el envio de un archivo al servidor
#+name: multer:html
#+begin_src html
<form id="frmUploader" enctype="multipart/form-data"
      action="http:/localhost:4000/user/test" method="post">
  <input type="file" name="csv"  /> <br>
  <input type="submit" name="submit" id="btnSubmit" value="Upload" />
</form>
#+end_src
** Código demo en /js/ para el servicio en el servidor
El input del /formdata/ tiene nombre _csv_ y este nombre se tiene que proporcionar en framework de ~multer~
#+name: multer:js
#+begin_src js
import Router from 'koa-router'
import multer from '@koa/multer'
const userRouter = new Router()
const upload = multer()

userRouter.prefix('/')
userRouter
  .post('/', upload.single('csv'), async (ctx: Context, next: Next) => {
    console.log(ctx.file.buffer.toString('utf-8'))
    ctx.status = 200
  })
#+end_src
* DB
- Run container :: ~docker-compose up~
- Enter to container :: ~docker-compose exec mysql mysql -uroot -ppassword~
** Ubigeo
- Fill /region/, /province/ and /district/ dbs run :: ~npm run seed~
* Routes
** Ubigeo
*** Regiones
#+begin_src restclient
GET :base-url/ubigeo/regions
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
#+end_src

*** Provincias
#+begin_src restclient
GET :base-url/ubigeo/provinces/01
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
#+end_src

*** Distrito
#+begin_src restclient
GET :base-url/ubigeo/districts/1803
Content-TypE: application/json;charset=UTF-8
Authorization: Bearer :token
#+end_src

** Create user
#+begin_src restclient
POST :base-url/user
Content-Type: application/json;charset=UTF-8
{
    "email":"crowdfunding@gmail.com",
    "name":"Ariana",
    "lastname":"Perez",
    "phone":"909823098123",
    "password":"roblox"
}
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "name": "ariana",
  "lastname": "perez",
  "phone": "909823098123",
  "email": "crowdfunding@gmail.com",
  "document": null,
  "createdAt": "2021-06-01T12:59:41.279Z",
  "updateAt": "2021-06-01T12:59:41.279Z",
  "id": 1
}
// POST http://localhost:4000/user
// HTTP/1.1 200 OK
// Vary: Origin
// Content-Type: application/json; charset=utf-8
// Content-Length: 192
// Date: Tue, 01 Jun 2021 07:59:41 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.227506s
#+END_SRC

** Login
#+begin_src restclient
POST :base-url/auth
Content-Type: application/json;charset=UTF-8
{
    "email":"crowdfunding@gmail.com",
    "password":"roblox"
}
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "error": false,
  "data": {
    "createdAt": "2021-05-09T12:18:35.930Z",
    "updateAt": "2021-05-09T12:18:36.285Z",
    "id": 1,
    "name": "ariana",
    "lastname": "perez",
    "phone": "909823098123",
    "document": null,
    "email": "crowdfunding@gmail.com"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJjcm93ZGZ1bmRpbmdAZ21haWwuY29tIiwiaWF0IjoxNjIyNTM2OTgxLCJleHAiOjE2MzExNzY5ODEsImp0aSI6IjFsNnpuMTNpaHBrcGRzbWo0YiJ9.q8p_mRF5Jj2RacIGW09KSrc4urq2ns9W5eE1HpBYnmg",
  "status": 200,
  "message": "ok"
}
// POST http://localhost:4000/auth
// HTTP/1.1 200 OK
// Vary: Origin
// Content-Type: application/json; charset=utf-8
// Content-Length: 471
// Date: Tue, 01 Jun 2021 08:43:01 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.143468s
#+END_SRC

#+begin_src restclient
POST :base-url/user/logout
Authorization: Bearer :token
#+end_src

*** Failed
- Wrong email
#+begin_src restclient :exports both
POST :base-url/auth
Content-Type: application/json;charset=UTF-8
{
    "email":"crowdfunding2@gmail.com",
    "password":"roblox"
}
#+end_src

#+RESULTS:
#+BEGIN_SRC text
El correo electrónico que ingresó no pertenece a ninguna cuenta.
POST http://localhost:4000/auth
HTTP/1.1 401 Unauthorized
Vary: Origin
Content-Type: text/plain; charset=utf-8
Content-Length: 66
Date: Tue, 04 May 2021 19:48:40 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Request duration: 0.011135s
#+END_SRC

- Wrong password
#+begin_src restclient :exports both
POST :base-url/auth
Content-Type: application/json;charset=UTF-8
{
    "email":"crowdfunding@gmail.com",
    "password":"roblox2"
}
#+end_src

#+RESULTS:
#+BEGIN_SRC text
Contraseña incorrecta
POST http://localhost:4000/auth
HTTP/1.1 401 Unauthorized
Vary: Origin
Content-Type: text/plain; charset=utf-8
Content-Length: 22
Date: Tue, 04 May 2021 19:50:18 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Request duration: 0.122258s
#+END_SRC

** Campaign
*** Create campaign
#+begin_src restclient
POST :base-url/user/campaign
Content-Type: application/json
Authorization: Bearer :token
{
    "name":"Regalando Sonrisas",
    "type":"materiales"
}
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "error": false,
  "data": {
    "name": "Regalando Sonrisas",
    "type": "materiales",
    "status": "creada",
    "image_url": "",
    "user": 2,
    "description": null,
    "release": null,
    "ending": null,
    "createdAt": "2021-06-01T13:43:37.348Z",
    "updateAt": "2021-06-01T13:43:37.348Z",
    "id": 29
  },
  "status": 200,
  "message": "ok"
}
// POST http://localhost:4000/user/campaign
// HTTP/1.1 200 OK
// Vary: Origin
// Content-Type: application/json; charset=utf-8
// Content-Length: 275
// Date: Tue, 01 Jun 2021 08:43:37 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.118600s
#+END_SRC

*** Update campaing
#+begin_src restclient :exports both
PUT :base-url/user/campaign/1
Content-Type: application/json
Authorization: Bearer :token
{
    "status": "creada",
    "image_url": "imagen",
    "description": "esto es una demo",
    "id": 10
}
#+end_src

*** List all campaigns by user
#+begin_src restclient
:base-url = http://localhost:4000/user/campaign
GET :base-url
Content-Type: application/json
Authorization: Bearer :token
#+end_src

** Beneficiary
*** Create beneficiary
#+begin_src restclient
POST :base-url/beneficiary
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "name": "Carmelolll",
    "lastname": "Gallo",
     "maternal_lastname": "Valiente",
    "sex": "m",
    "nse": "__",
    "document": "65465412",
    "age": 45,
    "district": 20,
    "address": "laskdjf",
    "status": "lsakdjf",
    "region": 1,
    "district": 1,
    "province": 1,
    "handicapped": "NSE-A",
    "campaign": 1
}
#+end_src

*** Get beneficiary by campaign

GET {{baseUrl}}/beneficiary?idCampaign=13
#+begin_src restclient
GET :base-url/beneficiary?idCampaign=13
Authorization: Bearer :token
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "error": false,
  "data": [
    {
      "createdAt": "2021-06-01T12:28:15.290Z",
      "updateAt": "2021-06-01T12:31:10.000Z",
      "id": 10,
      "name": "asdads",
      "lastname": "asdads",
      "maternal_lastname": "asdads",
      "sex": "Femenino",
      "nse": "NSE A",
      "document": "42103549",
      "age": 12,
      "district": "",
      "region": "",
      "province": "0102",
      "address": "asdadsa",
      "handicapped": false,
      "status": "asociado"
    }
  ],
  "status": 200,
  "message": "ok"
}
// GET http://localhost:4000/beneficiary?idCampaign=13
// HTTP/1.1 200 OK
// Vary: Origin
// Content-Type: application/json; charset=utf-8
// Content-Length: 370
// Date: Tue, 01 Jun 2021 20:02:46 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.012523s
#+END_SRC

*** Update beneficiary
#+begin_src restclient
PUT :base-url/beneficiary
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "id": 5,
    "name": "Carmela",
    "lastname": "Gallo",
     "maternal_lastname": "Valiente",
    "sex": "m",
    "nse": "__",
    "document": "65465412",
    "age": 45,
    "district": 20,
    "address": "laskdjf",
    "handicapped":true,
    "campaign": 13
}
#+end_src

*** Delete beneficiary
#+begin_src restclient
PUT :base-url/beneficiary/remove
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "id": 12,
    "name": "Carmelo",
    "lastname": "Torres",
     "maternal_lastname": "Valiente",
    "sex": "m",
    "nse": "__",
    "document": "65465412",
    "age": 45,
    "district": 20,
    "address": "laskdjf",
    "handicapped":true,
    "campaign": 13
}
#+end_src

** Donation
*** Create donation
#+begin_src restclient
POST :base-url/donation
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
  "name": "Lentejas",
  "description": "Bolsas de 1kg",
  "category": "Viveres",
  "amountByBeneficiary": 2,
  "campaign": "2",
}
#+end_src

*** Get donations by campaign
#+begin_src restclient
GET :base-url/donation?idCampaign=2
Authorization: Bearer :token
#+end_src

*** Update donation
#+begin_src restclient
PUT :base-url/donation
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "id": 5,
    "name": "Lentejes",
    "description": "Bolsas de 1kg",
    "category": "Viveres",
    "amountByBeneficiary": 2,
    "campaign": "2",
}
#+end_src

*** Delete donation
#+begin_src restclient
PUT :base-url/donation/remove
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "id": 12,
    "name": "Lentejas",
    "description": "Bolsas de 1kg",
    "category": "Viveres",
    "amountByBeneficiary": 2,
    "campaign": "2",
}
#+end_src

** Volunteer
*** Add volunteer
#+begin_src restclient
POST :base-url/volunteer
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
{
    "name": "Carmelolll",
    "lastname": "Gallo perez",
    "phone": "0982374098324",
    "email": "vv@gmail.com",
    "campaign": 2
}
#+end_src

*** Get by campaign
#+begin_src restclient
GET :base-url/volunteer/2
Content-Type: application/json;charset=UTF-8
Authorization: Bearer :token
#+end_src

#+RESULTS:
#+BEGIN_SRC js
[
  {
    "name": "carmelolll",
    "lastname": "gallo perez",
    "phone": "0982374098324",
    "email": "jj@gmail.com"
  },
  ...
]
// GET http://localhost:4000/volunteer/2
// HTTP/1.1 200 OK
// Vary: Origin
// Content-Type: application/json; charset=utf-8
// Content-Length: 1517
// Date: Wed, 05 May 2021 06:54:59 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
// Request duration: 0.062789s
#+END_SRC

** Giver
*** Create giver
#+begin_src restclient
POST :base-url/giver
Content-Type: application/json;charset=UTF-8
{
    "name" : "Valeria Nadine",
    "lastname" : "Vicuña",
    "email" : "valeria.vicuna@pucp.edu.pe",
    "document" : "119",
    "phone" : "976337742",
    "campaign" : 1
}
#+end_src

#+RESULTS:
#+BEGIN_SRC text
OK
POST http://localhost:4000/giver
HTTP/1.1 200 OK
Vary: Origin
Content-Type: text/plain; charset=utf-8
Content-Length: 2
Date: Mon, 17 May 2021 03:16:29 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Request duration: 2.958812s
#+END_SRC

*** Get Givers
GET {{baseUrl}}/giver/campaign/13 HTTP/1.1
content-type: application/json
Authorization: Bearer {{token2}}

*** Register donation
**** New event
#+begin_src restclient
POST :base-url/giver/31/donation/
Content-TypE: application/json;charset=UTF-8
Authorization: Bearer :token
{
  "campaignId": 29,
  "donations": [
     {
       "donationId": 14,
       "amount": 10
     }
  ],
  "pickup": true,
  "event": {
    "startDate": "12-16-20",
    "details": "Al frente de tottus",
    "address": "Av Predo Miot 512"
  }
}
#+end_src

#+RESULTS:
#+BEGIN_SRC text
OK
POST http://localhost:4000/giver/31/donation/
HTTP/1.1 200 OK
Vary: Origin
Content-Type: text/plain; charset=utf-8
Content-Length: 2
Date: Tue, 01 Jun 2021 09:28:39 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Request duration: 0.363308s
#+END_SRC

**** Defined events 
#+begin_src restclient
POST :base-url/giver/1/donation/
Content-TypE: application/json;charset=UTF-8
Authorization: Bearer :token
{
  "giverId": 12,
  "donations": [
    {
      "donationId": 14,
      "amount": 10
    }
  ],
  "pickup": false,
  "event": {
    "id": 1
  }
}
#+end_src

#+RESULTS:
#+BEGIN_SRC text
Method not implemented.
POST http://localhost:4000/giver/1/donation/
HTTP/1.1 500 Internal Server Error
Vary: Origin
Content-Type: text/plain; charset=utf-8
Content-Length: 23
Date: Tue, 01 Jun 2021 09:54:20 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Request duration: 0.039343s
#+END_SRC
